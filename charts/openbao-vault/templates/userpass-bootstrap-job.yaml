{{- if .Values.userpassBootstrap.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: userpass-bootstrap-{{ .Values.vault.name }}
  namespace: {{ include "openbao.namespace" . }}
  labels:
    {{- include "openbao.labels" . | nindent 4 }}
    component: userpass-bootstrap
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "20"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: {{ .Values.userpassBootstrap.backoffLimit }}
  activeDeadlineSeconds: {{ .Values.userpassBootstrap.activeDeadlineSeconds }}
  ttlSecondsAfterFinished: {{ .Values.userpassBootstrap.ttlSecondsAfterFinished }}
  template:
    metadata:
      labels:
        {{- include "openbao.labels" . | nindent 8 }}
        component: userpass-bootstrap
    spec:
      restartPolicy: OnFailure
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
      - name: userpass-bootstrap
        image: "{{ .Values.userpassBootstrap.image.repository }}:{{ .Values.userpassBootstrap.image.tag }}"
        imagePullPolicy: {{ .Values.userpassBootstrap.image.pullPolicy }}
        env:
        - name: VAULT_ADDR
          value: {{ .Values.userpassBootstrap.vaultAddr | quote }}
        - name: VAULT_SKIP_VERIFY
          value: "true"
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ .Values.userpassBootstrap.tokenSecret.name }}
              key: {{ .Values.userpassBootstrap.tokenSecret.key }}
        command:
        - /bin/sh
        - -c
        - |
          set -euo pipefail

          echo "üîê Starting userpass bootstrap job"
          echo "Using vault address: ${VAULT_ADDR}"

          MOUNT_PATH="{{ .Values.userpassBootstrap.mountPath }}"
          echo "Target userpass mount path: ${MOUNT_PATH}"

          timeout={{ .Values.userpassBootstrap.waitTimeoutSeconds }}
          echo "Waiting for Vault to respond (timeout: ${timeout}s)..."
          while [ ${timeout} -gt 0 ]; do
            if vault status >/dev/null 2>&1; then
              echo "‚úÖ Vault is reachable"
              break
            fi
            sleep 5
            timeout=$((timeout - 5))
          done

          if [ ${timeout} -le 0 ]; then
            echo "‚ùå Timeout waiting for Vault API"
            exit 1
          fi

          if vault auth list -format=json | grep -q "\"${MOUNT_PATH}/\""; then
            echo "‚ÑπÔ∏è  userpass auth method already enabled at ${MOUNT_PATH}/"
          else
            echo "Enabling userpass auth method at ${MOUNT_PATH}/..."
            vault auth enable -path="${MOUNT_PATH}" userpass
            echo "‚úÖ Enabled userpass auth at ${MOUNT_PATH}/"
          fi

{{- $mountPath := .Values.userpassBootstrap.mountPath | default "userpass" -}}
{{- range $index, $user := .Values.userpassBootstrap.users }}
          echo "Configuring user '{{ $user.username }}'"
          vault write auth/{{ $mountPath }}/users/{{ $user.username }} password='{{ $user.password }}'{{ if $user.policies }} policies='{{ join "," $user.policies }}'{{ end }}{{ if $user.tokenPolicies }} token_policies='{{ join "," $user.tokenPolicies }}'{{ end }}{{ if $user.tokenTtl }} token_ttl={{ $user.tokenTtl }}{{ end }}{{ if $user.tokenMaxTtl }} token_max_ttl={{ $user.tokenMaxTtl }}{{ end }}
{{- end }}

          echo "‚úÖ Userpass bootstrap completed"
        resources:
          {{- toYaml .Values.userpassBootstrap.resources | nindent 10 }}
{{- end }}
