# Microsoft Phi-3 Model Configuration
model:
  name: phi3-38b
  fullName: phi3:3.8b-mini-instruct-4k-fp16
  displayName: "Microsoft Phi-3 3.8B Mini Instruct"
  url: "https://ollama.com/library/phi3"
  size: "2.2GB"

# Namespace configuration
namespace:
  create: true

# NFS configuration for Phi3 model
nfs:
  image:
    repository: boyroywax/nfs-server
    tag: 1.0.0
    pullPolicy: IfNotPresent
  storage:
    size: 25Gi  # Larger storage for Phi3
    storageClass: do-block-storage
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  securityContext:
    runAsUser: 0
    runAsGroup: 0
    fsGroup: 1001
    privileged: true

# Ollama configuration optimized for Phi3
ollama:
  image:
    repository: ollama/ollama
    tag: "0.11.10"
    pullPolicy: IfNotPresent
  replicaCount: 1
  
  resources:
    requests:
      memory: "3Gi"  # More memory for Phi3
      cpu: "500m"
    limits:
      memory: "6Gi"  # Higher limit for Phi3
      cpu: "2000m"
  
  probes:
    readiness:
      enabled: true
      httpGet:
        path: /
        port: 11434
      initialDelaySeconds: 30
      periodSeconds: 10
    liveness:
      enabled: true
      httpGet:
        path: /
        port: 11434
      initialDelaySeconds: 60
      periodSeconds: 30

# Service configuration
service:
  type: ClusterIP
  port: 11434
  targetPort: 11434

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  host: phi3-38b.ollama.ai.layerwork.space
  path: /
  pathType: Prefix
  tls:
    enabled: true
    secretName: phi3-38b-tls

# Model download job configuration
modelDownload:
  enabled: true
  image:
    repository: ollama/ollama
    tag: "0.11.10"
  backoffLimit: 3
  resources:
    requests:
      memory: "2Gi"
      cpu: "500m"
    limits:
      memory: "4Gi"
      cpu: "1000m"

# Node affinity and tolerations (optional)
# Uncomment and configure these if you want to schedule pods on specific nodes
# 
# For dedicated AI nodes with taints:
# Node affinity to prefer the dedicated phi3-38b node (flexible scheduling)
tolerations:
  - key: "ollama"
    operator: "Equal"
    value: "dedicated"
    effect: "NoSchedule"

affinity:
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      preference:
        matchExpressions:
        - key: "node-role.kubernetes.io/phi3-38b"
          operator: Exists
    - weight: 50
      preference:
        matchExpressions:
        - key: "kubernetes.io/arch"
          operator: In
          values:
          - "amd64"
